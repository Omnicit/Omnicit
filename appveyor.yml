os:
  - "WMF 5"

branches:
  only:
    - master

install:
  - ps: |
      $null = Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.208 -Force
      $null = Install-Module -Name Pester -MinimumVersion 4.8.1 -Scope CurrentUser -Force
      $null = Install-Module -Name psake -MinimumVersion 4.8.0 -Scope CurrentUser -Force
      $null = Install-Module -Name PSScriptAnalyzer -MinimumVersion 1.18.0 -Scope CurrentUser -Force
      $null = Install-Module -Name platyPS -MinimumVersion 0.14.0 -Scope CurrentUser -Force

build_script:
  - ps: |
      $TestResultsFile = Join-Path $pwd -ChildPath "$PSScriptRoot/TestResults.xml"
      Invoke-psake build.psake.ps1 -taskList Test, BuildHelp -properties @{"TestOutputFile" = $TestResultsFile}
      if ($psake.build_success -and (Test-Path $TestResultsFile)) {
          (New-Object 'System.Net.WebClient').UploadFile("https://ci.appveyor.com/api/testresults/nunit/$($env:APPVEYOR_JOB_ID)", $TestResultsFile)
      }
      else {
          # Terminate the script to fail the build
          $Error | Format-List * -Force
          exit 1;
      }

on_finish:
    - ps: |
        # Publish the contents of the Release folder
        $ZipPath = "$pwd\Omnicit.zip"
        Compress-Archive -Path "$pwd\Release" -DestinationPath $ZipPath
        Push-AppveyorArtifact $ZipPath
